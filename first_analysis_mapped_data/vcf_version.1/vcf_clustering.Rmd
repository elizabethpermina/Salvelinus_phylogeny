---
title: "vcf_clustering"
author: "EPermina"
date: "15 April 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}


if(!require(tidyverse)){
  install.packages("tidyverse")
}

if(!require(SNPRelate)){ 
source("https://bioconductor.org/biocLite.R")
biocLite("SNPRelate")
}

set.seed(1680) # for reproducibility

if(!require(ISLR)) {
  install.packages("ISLR")
}

if(!require(cluster)) {
  install.packages("cluster")
}

if(!require(Rtsne)) {
  install.packages("Rtsne")
}

library(cluster) # for gower similarity and pam
library(Rtsne) # for t-SNE plot
library(tidyverse)
library(SNPRelate)
library(reshape2)
set.seed(1680) # for reproducibility
```

### Data manipulation, reading in

first_analysis/populations.snps.vcf.filtered.for.non-presence.presumed.0.samplesOnly.txt is a modified populations.snps.vcf file

1. all samples with no coverage of SNPs (./. only columns) were removed
1. vcf header has also been removed
1. ./. is replaced with 0/0:0:0,0

Finding relevant files on the users computer and reading these in
files:
populations.snps.vcf.Z.txt
populations.snps.vcf.Z.headless.sampleNames.trimmed.txt
populations.snps.vcf.split.info.genotype.coverage.txt

```{r, engine='bash', eval = FALSE}
cat populations.snps.vcf.Z.txt | sed 's/.single//g' | tail -n +15 | cut -f10- > populations.snps.vcf.Z.headless.sampleNames.trimmed.txt
```


```{r, engine='bash', eval = FALSE}

cat genotype.txt | sed 's#0/1#0.5#g' | sed 's#0/0#0#g' | sed 's#1/1#1#g' > genotype.01.txt
```




```{r}
# read in bash-splitted file
genotype_split<-read.delim("../populations.snps.vcf.split.info.genotype.coverage.txt", header = F, sep = '\t')
genotype_raw<-read.delim("../populations.snps.vcf.Z.headless.sampleNames.trimmed.txt", sep = "\t", header = TRUE) 

genotype_names_in_split <- paste(names, ".1.geno", sep="") # genotype names in split
coverage_names_in_split <- paste(names, ".2.cover", sep="") # coverage names in split
pro<- paste(names, ".3.pro", sep="") # coverage names in split

#bind 3 vectors
 z <- as.vector(rbind(genotype_names_in_split,coverage_names_in_split,pro)) 
names(genotype_split)<-z

coverage_cols<-grepl("2.cover", names(genotype_split))
genotype_cols<-grepl("1.geno", names(genotype_split))
coverage<-genotype_split[coverage_cols]
genotype<- read.delim("genotype.01.txt", sep = "\t", header = TRUE)
t.coverage<-t(as.matrix(coverage))
t.genotype<-t(as.matrix(genotype))
```


Clustering - 
 - coverage and genotype
```{r}


 # df3 = merge(t.coverage, t.genotype, by.x=row.names(t.coverage), by.y=row.names(t.genotype))

# Applying Ward Hierarchical Clustering
d_coverage   <- dist(t.coverage, method="euclidean")
ward_fit_coverage <- hclust(d_coverage, method="ward")
g4_ward_coverage <- cutree(ward_fit_coverage, k = c(4))
g8_ward_coverage <- cutree(ward_fit_coverage, k = c(8))

#using Gower via daisy
gower_dist_genotype <- daisy(t.genotype,
                    metric = "gower",
                    type = list(logratio = 3))
gower_mat_genotype <- as.matrix(gower_dist_genotype)


tsne_obj_genotype <- Rtsne(gower_dist_genotype, is_distance = TRUE)
pam_fit_genotype <- pam(gower_dist_genotype, diss = TRUE, k = 3)
tsne_data_genotype <- tsne_obj_genotype$Y %>%
  data.frame() %>%
  setNames(c("X", "Y")) %>%
  mutate(cluster = factor(pam_fit_genotype$clustering),
         name = row.names(t.genotype))


# Gower clusters for coverage:

gower_dist_coverage <- daisy(t.coverage,
                    metric = "gower",
                    type = list(logratio = 3))
gower_mat_coverage <- as.matrix(gower_dist_coverage)


tsne_obj_coverage <- Rtsne(gower_dist_coverage, is_distance = TRUE)
pam_fit_coverage <- pam(gower_dist_coverage, diss = TRUE, k = 3)
tsne_data_coverage <- tsne_obj_coverage$Y %>%
  data.frame() %>%
  setNames(c("X", "Y")) %>%
  mutate(cluster = factor(pam_fit_coverage$clustering),
         name = row.names(t.coverage))

```

Writing data out 

```{r}
write.table(tsne_data_genotype, file="genotype_clusters.csv", quote = FALSE, sep = ",")
write.table(g8_ward_coverage, file="coverage_groups.csv", quote = FALSE, sep = ",")
#write.table()

```

Plots:
Ward clustered dendrogram for coverage:
```{r}
plot(ward_fit_coverage)
```

Genotype clusters:
```{r}
ggplot(aes(x = X, y = Y), data = tsne_data_genotype) +
  geom_point(aes(color = cluster))
```

Samples in genotype clusters:

```{r}
tsne_data_genotype
```

Coverage Gower clusters:

```{r}
ggplot(aes(x = X, y = Y), data = tsne_data_coverage) +
  geom_point(aes(color = cluster))
```

Samples and coverage clusters:

```{r}
tsne_data_coverage
```


